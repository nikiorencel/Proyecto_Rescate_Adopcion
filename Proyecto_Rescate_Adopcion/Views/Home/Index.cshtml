@model Proyecto_Rescate_Adopcion.ViewModels.HomeView

@{
    ViewData["Title"] = "Inicio";
    Layout = "_Layout";
}

<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

@{

    var pendientes = ViewBag.Pendientes as HashSet<int> ?? new HashSet<int>();
    Func<int, bool> P = id => pendientes.Contains(id);
    string F(string? foto) => string.IsNullOrWhiteSpace(foto) ? Url.Content("~/placeholder.jpg") : foto!;

    Func<int, bool> YaPend = id => pendientes.Contains(id);
    Func<int, string> BtnTxt = id => YaPend(id) ? "Ya solicitada" : "Solicitar adopción";
    Func<int, string> BtnCls = id => YaPend(id) ? "btn is-disabled" : "btn"; 
    Func<int, string> BtnAttr = id => YaPend(id) ? "disabled=\"disabled\" aria-disabled=\"true\" tabindex=\"-1\"" : "";
    Func<int, string> BtnTtl = id => YaPend(id) ? "Ya tenés una solicitud pendiente" : "Solicitar adopción";


    Func<string?, string?, string> PickImg = (foto, especie) =>
    {
        if (!string.IsNullOrWhiteSpace(foto)) return foto!;
        var esp = (especie ?? "").ToLowerInvariant();
        if (esp.Contains("gato")) return Url.Content("~/Gato1.png");
        if (esp.Contains("conejo")) return Url.Content("~/Conejo1.png");
        return Url.Content("~/Perro1.png");
    };

    bool hayModel = (ViewData.Model != null)
                    && ViewData.Model.GetType().GetProperty("Animales") != null;
    var animales = hayModel
        ? (IEnumerable<dynamic>)(ViewData.Model.GetType().GetProperty("Animales")!.GetValue(ViewData.Model) ?? Enumerable.Empty<object>())
        : Enumerable.Empty<dynamic>();

    int? Page = hayModel ? (int?)ViewData.Model.GetType().GetProperty("Page")?.GetValue(ViewData.Model) : null;
    int? TotalPages = hayModel ? (int?)ViewData.Model.GetType().GetProperty("TotalPages")?.GetValue(ViewData.Model) : null;
    bool HasPrev = hayModel ? ((bool?)ViewData.Model.GetType().GetProperty("HasPrev")?.GetValue(ViewData.Model) ?? false) : false;
    bool HasNext = hayModel ? ((bool?)ViewData.Model.GetType().GetProperty("HasNext")?.GetValue(ViewData.Model) ?? false) : false;
}

<div class="container">

    <section class="hero">
        <div class="hero-card">
            <h2>Encuentra a tu nueva mascota</h2>
            <p>Explora mascotas que necesitan un hogar y gestiona el proceso de adopción.</p>
            <form asp-controller="Animal" asp-action="Index" method="get" class="search">
                <input type="text" name="localidad" placeholder="Localidad" />
                <button type="submit" title="Buscar">🔍</button>
            </form>
        </div>
    </section>


    <section class="quick">
        <div class="qcard">
            <div class="qicon">↗</div>
            <div>
                <a class="qtitle" asp-controller="Animal" asp-action="Create">
                    Registrar Mascota
                </a>
                <p class="qdesc">Da de alta mascotas en adopción con facilidad.</p>
            </div>
        </div>
        <div class="qcard">
            <div class="qicon">📄</div>
            <div>
                <a class="qtitle" asp-controller="Adopcion" asp-action="MisSolicitudes">
                    Solicitudes de Adopción
                </a>
                <p class="qdesc">Revisa y gestiona las solicitudes pendientes.</p>
            </div>
        </div>
        <div class="qcard">
            <div class="qicon">🐾</div>
            <div>
                <a class="qtitle" asp-controller="Adopcion" asp-action="Historial">
                    Historial de Adopciones
                </a>
                <p class="qdesc">Consulta el estado y tu historial.</p>
            </div>
        </div>
        <div class="qcard">
            <div class="qicon">📢</div>
            <div>
                <a class="qtitle" asp-controller="Animal" asp-action="MisPublicaciones">
                    Mis publicaciones
                </a>
                <p class="qdesc">Administra las mascotas que publicaste.</p>
            </div>
        </div>

    </section>

    <h3>Mascotas en Adopción</h3>
    <section class="slider">
        <button class="nav prev" type="button">&#x276E;</button>
        <div class="slider-viewport">
            <div class="slider-track">
                @foreach (var a in Model.Animales)
                {
                    <article class="card">
                        <img src="@a.FotoUrl" alt="@a.NombreAnimal" />
                        <div class="card-body">
                            <p class="name">@a.NombreAnimal</p>
                            <p class="meta">@a.Localidad</p>
                            <p class="meta">
                                @(a.Sexo == "Macho" ? "♂ Macho" :
                                                            a.Sexo == "Hembra" ? "♀ Hembra" : "Sexo: Sin definir")
                                –
                                @(
                                                            a.Edad == null ? "Edad desconocida"
                                                            : a.Edad == 1 ? "1 año"
                                                            : $"{a.Edad} años"
                                                            )
                            </p>


                            @if (a.Estado == "Pendiente")
                            {
                                <span class="badge badge--pendiente" style="margin-bottom:8px;display:inline-block;">
                                    Con solicitudes
                                </span>
                            }
                        </div>

                        <a asp-controller="Animal" asp-action="Details" asp-route-id="@a.IdSolicitud" class="link-detalle">
                            Ver detalles
                        </a>


                    </article>
                }
            </div>
        </div>
        <button class="nav next" type="button">&#x276F;</button>
    </section>

@section Scripts {
        <script>
            (() => {
              const vp   = document.querySelector('.slider-viewport');
              const trk  = document.querySelector('.slider-track');
              const prev = document.querySelector('.slider .prev');
              const next = document.querySelector('.slider .next');
              if (!vp || !trk || !prev || !next) return;

              const cards = Array.from(trk.children);
              if (cards.length === 0) return;

              const gap = parseFloat(getComputedStyle(trk).columnGap || getComputedStyle(trk).gap || '16') || 16;
              let current = 0;

              function visibleCount() {
                const cw = cards[0].getBoundingClientRect().width;
                const vw = vp.getBoundingClientRect().width;
                return Math.max(1, Math.floor((vw + gap) / (cw + gap)));
              }

              function update() {
                const cw = cards[0].getBoundingClientRect().width;
                const n  = visibleCount();
                const stepWidth = n * cw + (n - 1) * gap;
                const maxStep = Math.max(0, Math.ceil(cards.length / n) - 1);
                if (current > maxStep) current = maxStep;
                trk.style.transform = `translateX(${-current * stepWidth}px)`;
                prev.disabled = current <= 0;
                next.disabled = current >= maxStep;
              }

              prev.addEventListener('click', () => { current = Math.max(0, current - 1); update(); });
              next.addEventListener('click', () => { current = current + 1; update(); });

              window.addEventListener('resize', () => {
                trk.style.transform = 'translateX(0)';
                current = 0;
                update();
              });


              const imgs = trk.querySelectorAll('img');
              let pending = 0;
              imgs.forEach(img => {
                if (!img.complete) { pending++; img.addEventListener('load', onImg, {once:true}); }
              });
              function onImg(){ if (--pending <= 0) update(); }

              if (pending === 0) {

                update();
              } else {

                window.addEventListener('load', update, {once:true});
              }
            })();
        </script>
}
